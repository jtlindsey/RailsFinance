<p id="notice"><%= notice %></p>

<div class="row">
  <div class="col-md-12">
    <div class="panel panel-primary">
      <div class="panel-heading panels-text">Username's Budget <%= link_to 'Edit Budget', budget_items_path %></div>
      <div class="panel-body">

        <table class="table table-striped table-hover table-condensed">
          <thead>
            <tr>
              <th>Category</th>
              <th>Period</th>              
              <th>Amount Budgeted</th>
              <th>Amount Spent</th>
              <th>Status</th>
              <th colspan="3"></th>
            </tr>
          </thead>

          <tbody>
            <% budget_spent = 0 %>
            <% @budget_items.each do |budget_item| %>
              <tr>
                <td><%= budget_item.category %></td>
                <td><%= budget_item.period %></td>
                <td><%= number_to_currency(budget_item.amount) %></td>

                  <% Transaction.where(category: budget_item.category).each {|transaction| budget_spent += transaction.amount} %>

                  <% if budget_item.amount >= budget_spent %>
                    <% @status = budget_spent %>
                  <% else %>
                    <% @status = "#{budget_spent} ( $#{budget_spent - budget_item.amount} Over Budget! )"%>
                  <% end %>

                  <% if budget_spent != 0 && (budget_spent / budget_item.amount * 100) > 100 %>
                    <% @over_budget_tag = "progress-bar-danger" %>
                    <% calculated_bar_width = 100 %>

                  <% elsif budget_spent != 0 && (budget_spent / budget_item.amount * 100) > 75 %>
                    <% @over_budget_tag = "progress-bar-warning" %>
                    <% calculated_bar_width = (budget_spent / budget_item.amount * 100) %>

                  <% else %>
                    <% @over_budget_tag = "" %>
                    <% calculated_bar_width = (budget_spent / budget_item.amount * 100) %>
                  <% end %>

                <td><%= number_to_currency(budget_spent) %></td>
                <td>
                  <div class="progress">
                    <div class="progress-bar <%= @over_budget_tag %> progress-bar-striped active" 
                      role="progressbar" aria-valuenow="100" aria-valuemin="0" 
                      aria-valuemax="<%= budget_item.amount %>" 
                      style="width: <%= calculated_bar_width %>%"> $<%= @status %>
                    </div>
                  </div>
                  <% budget_spent = 0 %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>

      </div>
    </div>
  </div>
</div>
